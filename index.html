<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Gestão de Ferramentas</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        input, select { padding:5px; margin:5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table, th, td { border: 1px solid #aaa; }
        th, td { padding: 8px; text-align: left; }
        .btn { padding: 6px 12px; cursor: pointer; }
        .devolvida { color: green; font-weight: bold; }
        .pendente { color: red; font-weight: bold; }
    </style>
</head>
<body>

<h2>Empréstimo de Ferramentas</h2>

<form id="formEmprestimo">
    <input type="text" id="numFerramenta" placeholder="Número da ferramenta" required>
    <input type="text" id="quemEntregou" placeholder="Entregue por (funcionário)" required>
    <input type="text" id="idPessoa" placeholder="ID da pessoa" required>
    <input type="text" id="nomePessoa" placeholder="Nome de quem pegou" required>
    <input type="date" id="dataEmprestimo" required>
    <button class="btn" type="submit">Registrar</button>
</form>

<h2>Ferramentas em circulação</h2>

<input type="text" id="busca" placeholder="Buscar por ferramenta, pessoa ou ID...">

<table>
<thead>
<tr>
    <th>Nº Ferramenta</th>
    <th>Data Empréstimo</th>
    <th>Entregue por</th>
    <th>Retirado por</th>
    <th>ID</th>
    <th>Status</th>
    <th>Data Entrega</th>
    <th>Ações</th>
</tr>
</thead>
<tbody id="listaEmprestimos"></tbody>
</table>

<!-- Seção do Log de Ferramenta -->
<div id="logFerramenta" style="display:none;">
    <h3>Histórico de Empréstimos</h3>
    <button onclick="window.location.href='index.html'">Voltar</button>
    <h4>Ferramenta: <span id="numFerramentaLog"></span></h4>
    <table>
        <thead>
            <tr>
                <th>Data</th>
                <th>Quem retirou</th>
                <th>ID</th>
                <th>Status</th>
                <th>Data Entrega</th>
            </tr>
        </thead>
        <tbody id="logHistorico"></tbody>
    </table>
</div>

<!-- Seção do Log por Pessoa -->
<div id="logPessoa" style="display:none;">
    <h3>Histórico de Empréstimos</h3>
    <button onclick="window.location.href='index.html'">Voltar</button>
    <h4>Histórico de: <span id="nomePessoaLog"></span></h4>
    <table>
        <thead>
            <tr>
                <th>Ferramenta</th>
                <th>Data</th>
                <th>Status</th>
                <th>Data Entrega</th>
            </tr>
        </thead>
        <tbody id="logHistoricoPessoa"></tbody>
    </table>
</div>

<button class="btn" onclick="exportarCSV()">Exportar para CSV</button>

<!-- ... cabeçalho e form permanecem iguais ... -->

<script>
const funcionarios = [
    { id: '123', nome: 'João Silva' },
    { id: '456', nome: 'Maria Souza' },
    { id: '789', nome: 'Carlos Oliveira' }
];

let emprestimos = JSON.parse(localStorage.getItem("emprestimos")) || [];

function salvar() {
    localStorage.setItem("emprestimos", JSON.stringify(emprestimos));
}

// Função para formatar datas para DD/MM/AAAA
function formatarData(dataStr) {
    if(!dataStr) return "-";
    const d = new Date(dataStr);
    const dia = String(d.getDate()).padStart(2, '0');
    const mes = String(d.getMonth() + 1).padStart(2, '0');
    const ano = d.getFullYear();
    return `${dia}/${mes}/${ano}`;
}

function listar() {
    const tbody = document.getElementById("listaEmprestimos");
    const filtro = document.getElementById("busca").value.toLowerCase();

    tbody.innerHTML = "";

    emprestimos
        .filter(e => 
            e.numFerramenta.toLowerCase().includes(filtro) ||
            e.nomePessoa.toLowerCase().includes(filtro) ||
            e.idPessoa.toLowerCase().includes(filtro)
        )
        .forEach((e, index) => {
            tbody.innerHTML += `
            <tr>
                <td><a href="#" onclick="verLogFerramenta('${e.numFerramenta}')">${e.numFerramenta}</a></td>
                <td>${formatarData(e.dataEmprestimo)}</td>
                <td>${e.quemEntregou.toUpperCase()}</td>
                <td><a href="#" onclick="verLogPessoa('${e.nomePessoa}')">${e.nomePessoa}</a></td>
                <td>${e.idPessoa}</td>
                <td class="${e.devolvida ? 'devolvida' : 'pendente'}">
                    ${e.devolvida ? 'Devolvida' : 'Pendente'}
                </td>
                <td>${formatarData(e.dataDevolucao)}</td>
                <td>
                    ${!e.devolvida ? `<button onclick="marcarDevolvido(${index})">Devolver</button>` : ""}
                </td>
            </tr>`;
        });
}

document.getElementById("formEmprestimo").addEventListener("submit", function(event) {
    event.preventDefault();

    const numFerramenta = document.getElementById("numFerramenta").value;

    const ferramentaExistente = emprestimos.some(e => e.numFerramenta === numFerramenta && !e.devolvida);
    if (ferramentaExistente) {
        alert("Esta ferramenta já está emprestada. Não é possível registrar novamente.");
        return;
    }

    const registro = {
        numFerramenta: numFerramenta,
        quemEntregou: document.getElementById("quemEntregou").value,
        nomePessoa: document.getElementById("nomePessoa").value,
        idPessoa: document.getElementById("idPessoa").value,
        dataEmprestimo: document.getElementById("dataEmprestimo").value,
        devolvida: false,
        dataDevolucao: null
    };

    emprestimos.push(registro);
    salvar();
    listar();
    this.reset();
});

function marcarDevolvido(index) {
    emprestimos[index].devolvida = true;
    emprestimos[index].dataDevolucao = new Date().toISOString().split("T")[0];
    salvar();
    listar();
}

function verLogFerramenta(numFerramenta) {
    const logFerramenta = emprestimos.filter(e => e.numFerramenta === numFerramenta);

    document.getElementById("numFerramentaLog").textContent = numFerramenta;
    const tbody = document.getElementById("logHistorico");
    tbody.innerHTML = "";

    logFerramenta.forEach(r => {
        tbody.innerHTML += `
        <tr>
            <td>${formatarData(r.dataEmprestimo)}</td>
            <td>${r.nomePessoa}</td>
            <td>${r.idPessoa}</td>
            <td class="${r.devolvida ? "devolvida" : "pendente"}">${r.devolvida ? "Devolvida" : "Pendente"}</td>
            <td>${formatarData(r.dataDevolucao)}</td>
        </tr>`;
    });

    document.getElementById("logFerramenta").style.display = 'block';
    document.getElementById("listaEmprestimos").style.display = 'none';
}

function verLogPessoa(nomePessoa) {
    const logPessoa = emprestimos.filter(e => e.nomePessoa === nomePessoa);

    document.getElementById("nomePessoaLog").textContent = nomePessoa;
    const tbody = document.getElementById("logHistoricoPessoa");
    tbody.innerHTML = "";

    logPessoa.forEach(r => {
        tbody.innerHTML += `
        <tr>
            <td>${r.numFerramenta}</td>
            <td>${formatarData(r.dataEmprestimo)}</td>
            <td class="${r.devolvida ? "devolvida" : "pendente"}">${r.devolvida ? "Devolvida" : "Pendente"}</td>
            <td>${formatarData(r.dataDevolucao)}</td>
        </tr>`;
    });

    document.getElementById("logPessoa").style.display = 'block';
    document.getElementById("listaEmprestimos").style.display = 'none';
}

function voltar() {
    document.getElementById("logFerramenta").style.display = 'none';
    document.getElementById("listaEmprestimos").style.display = 'block';
}

function voltarPessoa() {
    document.getElementById("logPessoa").style.display = 'none';
    document.getElementById("listaEmprestimos").style.display = 'block';
}

function exportarCSV() {
    const headers = ["Nº Ferramenta", "Data", "Entregue por", "Retirado por", "ID", "Status", "Data de Entrega"];
    
    const rows = emprestimos.map(e => [
        e.numFerramenta,
        formatarData(e.dataEmprestimo),
        e.quemEntregou,
        e.nomePessoa,
        e.idPessoa,
        e.devolvida ? "Devolvida" : "Pendente",
        formatarData(e.dataDevolucao)
    ]);

    // Adiciona aspas a cada valor para proteger vírgulas
    let csvContent = "data:text/csv;charset=utf-8," + headers.map(h => `"${h}"`).join(";") + "\n";
    rows.forEach(row => {
        csvContent += row.map(val => `"${val}"`).join(";") + "\n";
    });

    const link = document.createElement("a");
    link.href = encodeURI(csvContent);
    link.download = "emprestimos_ferramentas.csv";
    link.click();
}

document.getElementById("idPessoa").addEventListener("input", function () {
    const f = funcionarios.find(p => p.id === this.value);
    document.getElementById("nomePessoa").value = f ? f.nome : "";
});

document.getElementById("numFerramenta").addEventListener("input", function () {
    this.value = this.value.replace(/\D/g, "");
});

document.getElementById("busca").addEventListener("input", listar);

listar();
</script>
</body>
</html>
